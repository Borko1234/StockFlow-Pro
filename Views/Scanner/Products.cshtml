@model StockFlowPro.ViewModels.ProductsViewModel

@{
    ViewData["Title"] = "Scan Products";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Order: #@Model.CurrentOrder.Id</h2>
        <a asp-action="Index" class="btn btn-secondary">&lt; Back to Scanner</a>
    </div>

    <div class="row">
        <!-- Scan Input -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Scan Product
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="barcodeInput" class="form-label">Product ID</label>
                        <input type="text" class="form-control" id="barcodeInput" autofocus placeholder="Scan or enter product ID">
                        <small class="text-muted">Use the Product ID from the Order Items table.</small>
                    </div>
                    <button type="button" id="scanBtn" class="btn btn-success w-100">Scan</button>
                    <button type="button" id="markScannedBtn" class="btn btn-primary w-100 mt-2" disabled>Mark Order as Scanned</button>
                    
                    <div id="scanResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Product List -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    Order Items
                </div>
                <div class="card-body">
                    <input type="text" id="filterInput" class="form-control mb-3" placeholder="Filter products...">

                    <table class="table table-striped" id="productsTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Product ID</th>
                                <th>Product Name</th>
                                <th>Brand</th>
                                <th>Unit Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.CurrentOrder.OrderItems)
                            {
                                for (var unitIndex = 0; unitIndex < item.Quantity; unitIndex++)
                                {
                                    <tr data-product-id="@item.Product.Id" data-product-name="@item.Product.Name" data-scanned="false">
                                        <td class="scan-status text-center">
                                            <span class="badge bg-secondary">Pending</span>
                                        </td>
                                        <td>@item.Product.Id</td>
                                        <td>@item.Product.Name</td>
                                        <td>@item.Product.Brand</td>
                                        <td>@item.UnitPrice.ToString("C")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Focus on barcode input
            $('#barcodeInput').focus();

            // Handle Scan
            $('#scanBtn').click(function () {
                scanProduct();
            });

            $('#barcodeInput').keypress(function (e) {
                if (e.which == 13) {
                    scanProduct();
                }
            });

            function scanProduct() {
                var barcode = $('#barcodeInput').val().trim();
                var orderId = @Model.CurrentOrder.Id;

                if (!barcode) {
                    $('#scanResult').html('<div class="alert alert-danger">Enter a product ID.</div>');
                    return;
                }

                if (!/^\d+$/.test(barcode)) {
                    $('#scanResult').html('<div class="alert alert-danger">Product ID must be numeric.</div>');
                    $('#barcodeInput').val('').focus();
                    return;
                }

                $.post('@Url.Action("ScanItem", "Scanner")', { orderId: orderId, barcode: barcode }, function (data) {
                    if (data.success) {
                        $('#scanResult').html('<div class="alert alert-success">Scanned: ' + data.displayName + '</div>');
                        
                        var row = $('#productsTable tbody tr').filter(function() {
                            return $(this).data('product-id') == data.productId && $(this).data('scanned') === false;
                        });

                        if (row.length > 0) {
                            var targetRow = row.first();
                            targetRow.find('.scan-status').html('<span class="badge bg-success">Scanned</span>');
                            targetRow.addClass('table-success');
                            targetRow.data('scanned', true);
                            targetRow.attr('data-scanned', 'true');
                            updateMarkScannedButton();
                        } else {
                            $('#scanResult').html('<div class="alert alert-warning">All units for this product are already scanned.</div>');
                        }

                        $('#barcodeInput').val('').focus();
                    } else {
                        $('#scanResult').html('<div class="alert alert-danger">' + data.message + '</div>');
                        $('#barcodeInput').val('').focus();
                    }
                });
            }

            function isAllScanned() {
                var rows = $('#productsTable tbody tr');
                if (!rows.length) return false;
                return rows.toArray().every(function (row) {
                    return $(row).find('.scan-status .badge').hasClass('bg-success');
                });
            }

            function updateMarkScannedButton() {
                var canComplete = isAllScanned();
                $('#markScannedBtn').prop('disabled', !canComplete);
            }

            $('#markScannedBtn').on('click', function () {
                var orderId = @Model.CurrentOrder.Id;
                if (!isAllScanned()) {
                    return;
                }

                var confirmed = confirm('Confirm marking this order as Scanned?');
                if (!confirmed) {
                    return;
                }

                $.post('@Url.Action("CompleteScan", "Scanner")', { orderId: orderId }, function (data) {
                    if (data && data.success) {
                        alert('Order marked as Scanned.');
                        window.location.href = '@Url.Action("Index", "Scanner")';
                    } else {
                        $('#scanResult').html('<div class="alert alert-danger">' + (data && data.message ? data.message : 'Unable to update order status.') + '</div>');
                    }
                });
            });

            updateMarkScannedButton();

            // Filter
            $('#filterInput').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#productsTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>
}
